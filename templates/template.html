<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>${headers['title']} ${headers['version']} - ${headers['subtitle']}</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
		<link href="${base}css/page.css?${version}" rel="stylesheet" />
	</head>
	<body class="d-flex flex-column vh-100">
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">
				<a class="navbar-brand" href="${base}">HAProxy Documentation</a>
				<button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#menu">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="menu">
					<ul class="navbar-nav me-auto">
						%for item in menu:
							<li class="nav-item"><a class="nav-link ${'active' if headers['subtitle'] == item[1] else ''}" href="${item[0]}">${item[1]}</a></li>
						%endfor
					</ul>
					<ul class="navbar-nav">
						<li class="nav-item"><a class="nav-link" href="http://www.haproxy.org/">HAProxy Home Page</a></li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="d-flex flex-grow-1 overflow-hidden">

			<aside id="sidebar" class="d-flex flex-column flex-shrink-0 bg-dark">
				<!-- Nav tabs (fixed at top) -->
				<div class="flex-shrink-0 p-3 pb-0">
					<ul class="nav nav-tabs" role="tablist">
						<li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-chapters" type="button" role="tab">Chapters</button></li>
						% if keywords:
						<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-keywords" type="button" role="tab">Keywords</button></li>
						% endif
					</ul>
				</div>
				
				<!-- Content wrapper (grows to fill space, contains scrollbar) -->
				<div class="flex-grow-1 overflow-hidden p-3 pt-0">
					<div class="h-100 overflow-auto bg-light text-body rounded-bottom p-3">
						<div class="tab-content">
							<div role="tabpanel" class="tab-pane active" id="tab-chapters">
								<%include file="_summary.html"/>
							</div>
							% if keywords:
							<div role="tabpanel" class="tab-pane" id="tab-keywords">
								<label for="filter" class="form-label">Filter</label>
								<input class="form-control mb-2" type="text" name="filter" id="filter" placeholder="Enter keyword to search...">
								<div id="keywords-list">
								<% previous_letter = None %>
								% for keyword in keywords:
									<% letter = keyword[0].upper() %>
									%if letter != previous_letter:
										% if previous_letter:
								</div>
										% endif
								<div class="letter mb-2" id="letter-${letter}"><strong class="d-block mb-1">${letter}</strong>
									<% previous_letter = letter %>
									%endif
								<a class="d-block py-1" href="#${keyword}">${keyword}</a>
								% endfor
								% if previous_letter:
								</div>
								% endif
								</div>
							</div>
							% endif
						</div>
					</div>
				</div>
				
				<!-- Footer (fixed at bottom) -->
				<div class="flex-shrink-0 border-top border-secondary p-3 text-light small">
					<p class="mb-1">
						Keyboard navigation: <span id="keyboardNavStatus"></span>
					</p>
					<p class="mb-1">
						Use <strong>left</strong> and <strong>right</strong> arrow keys to navigate between chapters.
					</p>
					<p class="mb-0 text-end">
						Converted with <a href="https://github.com/cbonte/haproxy-dconv">haproxy-dconv</a> v<b>${version}</b> on <b>${date}</b>
					</p>
				</div>
			</aside>

			<main id="content" class="flex-grow-1 d-flex flex-column overflow-hidden">
				<!-- Breadcrumbs bar -->
				<nav id="breadcrumbs" class="flex-shrink-0 py-2 px-3 bg-dark">
					<small><ol class="breadcrumb mb-0 ps-0">
						<li class="breadcrumb-item"><a href="#top" class="text-light">${headers['subtitle']}</a></li>
					</ol></small>
				</nav>
				
				<!-- Content area -->
				<div class="flex-grow-1 overflow-auto">
					<div class="container-fluid py-4">
						<div class="text-center mb-4">
							<h1><a href="http://www.haproxy.org/" title="HAProxy"><img src="${base}img/HAProxyCommunityEdition_60px.png?${version}" /></a></h1>
							%if headers['title'] != 'HAProxy':
							<h1>${headers['title']}</h1>
							%endif
							<h2>${headers['subtitle']}</h2>
							<p><strong>${headers['version']}</strong></p>
							<p>
								${headers['author']}<br>
								${headers['date']}
							</p>
						</div>

						${document}

					<hr>
					<div class="text-end">
						${headers['title']} ${headers['version'].replace("version ", "")} &ndash; ${headers['subtitle']}<br>
						<small class="text-muted">${headers['date']}, ${headers['author']}</small>
					</div>
					<a id="bottom" name="bottom"></a>
				</div>
				${footer}
				</div>
			</main>

		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			// Keyword filter - maximum performance optimization
			(function() {
				var keywordsList = document.getElementById('keywords-list');
				var filterInput = document.getElementById('filter');
				
				if (!keywordsList || !filterInput) return;
				
				// Pre-compute all link data once at init
				var linkData = [];
				var letters = keywordsList.querySelectorAll('.letter');
				var links = keywordsList.querySelectorAll('a');
				
				for (var i = 0; i < links.length; i++) {
					linkData.push({
						element: links[i],
						text: links[i].textContent.toLowerCase(),
						letter: links[i].closest('.letter')
					});
				}
				
				var debounceTimer;
				filterInput.addEventListener('input', function() {
					clearTimeout(debounceTimer);
					debounceTimer = setTimeout(function() {
						var text = filterInput.value.toLowerCase();
						var visibleLetters = new Set();
						var updates = [];
						
						for (var i = 0; i < linkData.length; i++) {
							var item = linkData[i];
							var match = !text || item.text.includes(text);
							updates.push({ element: item.element, match: match });
							if (match && item.letter) visibleLetters.add(item.letter);
						}
						
						requestAnimationFrame(function() {
							for (var i = 0; i < updates.length; i++) {
								updates[i].element.classList.toggle('d-none', !updates[i].match);
							}
							for (var i = 0; i < letters.length; i++) {
								letters[i].classList.toggle('d-none', !visibleLetters.has(letters[i]));
							}
						});
					}, 30);
				});
			})();
		</script>
		<script>
			// Navigation and breadcrumbs - super optimized
			(function() {
				var content = document.getElementById('content');
				var breadcrumbs = document.getElementById('breadcrumbs');
				var breadcrumbList = breadcrumbs.querySelector('.breadcrumb');
				var sidebarContent = document.querySelector('#sidebar .bg-light');
				
				// Pre-compute sections data once at init
				var sections = [];
				var sectionMap = {}; // Map target to section data for breadcrumb hierarchy
				var headingElements = document.querySelectorAll('[data-target]');
				for (var i = 0; i < headingElements.length; i++) {
					var el = headingElements[i];
					var target = el.getAttribute('data-target');
					var text = el.textContent.trim();
					var section = {
						element: el,
						target: target,
						text: text
					};
					sections.push(section);
					sectionMap[target] = section;
				}
				
				// Pre-compute sidebar chapter links for highlighting
				var chapterLinks = {};
				var allChapterLinks = sidebarContent.querySelectorAll('#tab-chapters a[href^="#"]');
				for (var i = 0; i < allChapterLinks.length; i++) {
					var link = allChapterLinks[i];
					var href = link.getAttribute('href').substring(1);
					chapterLinks[href] = link;
				}
				
				var currentTarget = null;
				var currentActiveLink = null;
				var rafId = null;
				
				// Find scroll container (the content's scrollable area, not sidebar)
				var scrollContainer = content.querySelector('.flex-grow-1.overflow-auto') || content.querySelector('.overflow-auto') || content;
				
				// Helper: parse "5.2.1. Title" into {num: "5.2.1", title: "Title"}
				function parseChapterText(text) {
					var dotSpaceIndex = text.indexOf('. ');
					if (dotSpaceIndex > 0) {
						return { num: text.substring(0, dotSpaceIndex), title: text.substring(dotSpaceIndex + 2) };
					}
					return null;
				}
				
				function updateBreadcrumbs(target, text) {
					if (target === currentTarget) return;
					currentTarget = target;
					
					// Build breadcrumb HTML with hierarchy
					var html = '<li class="breadcrumb-item"><a href="#top" class="text-light">' + document.title.split(' - ')[1] + '</a></li>';
					
					if (target && text) {
						// Extract chapter number and title
						var parsed = parseChapterText(text);
						if (parsed) {
							var chapterNum = parsed.num;
							var chapterTitle = parsed.title;
							
							// Build hierarchy of parent chapters (exclude current)
							var parts = chapterNum.split('.');
							var parents = [];
							for (var i = 0; i < parts.length - 1; i++) {
								var parentTarget = parts.slice(0, i + 1).join('.');
								if (sectionMap[parentTarget]) {
									var parentText = sectionMap[parentTarget].text;
									var parentParsed = parseChapterText(parentText);
									parents.push({
										target: parentTarget,
										num: parentParsed ? parentParsed.num : parentTarget,
										title: parentParsed ? parentParsed.title : parentText
									});
								}
							}
							
							// Add parent crumbs with ellipsis for middle items
							if (parents.length > 1) {
								// First parent
								html += '<li class="breadcrumb-item"><a href="#' + parents[0].target + '" class="text-light">' + parents[0].num + '. ' + parents[0].title + '</a></li>';
								
								// Ellipsis for middle items
								if (parents.length > 2) {
									html += '<li class="breadcrumb-item text-secondary">â€¦</li>';
								}
								
								// Last parent
								var lastParent = parents[parents.length - 1];
								html += '<li class="breadcrumb-item"><a href="#' + lastParent.target + '" class="text-light">' + lastParent.num + '. ' + lastParent.title + '</a></li>';
							} else if (parents.length === 1) {
								html += '<li class="breadcrumb-item"><a href="#' + parents[0].target + '" class="text-light">' + parents[0].num + '. ' + parents[0].title + '</a></li>';
							}
							
							// Add current chapter
							html += '<li class="breadcrumb-item active text-light">' + chapterNum + '. ' + chapterTitle + '</li>';
						} else {
							html += '<li class="breadcrumb-item active text-light">' + text + '</li>';
						}
					}
					
					breadcrumbList.innerHTML = html;
				}
				
				function updateSidebarHighlight(target) {
					// Remove previous active
					if (currentActiveLink) {
						currentActiveLink.classList.remove('active');
					}
					
					// Find new active link in chapters
					var newLink = chapterLinks[target];
					
					if (newLink) {
						newLink.classList.add('active');
						currentActiveLink = newLink;
					} else {
						currentActiveLink = null;
					}
				}
				
				function onScroll() {
					if (rafId) cancelAnimationFrame(rafId);
					
					rafId = requestAnimationFrame(function() {
						var contentRect = scrollContainer.getBoundingClientRect();
						var found = null;
						
						// Reverse search for current section
						for (var i = sections.length - 1; i >= 0; i--) {
							var rect = sections[i].element.getBoundingClientRect();
							if (rect.top <= contentRect.top + 100) {
								found = sections[i];
								break;
							}
						}
						
						if (found) {
							updateBreadcrumbs(found.target, found.text);
							updateSidebarHighlight(found.target);
						} else {
							updateBreadcrumbs(null, null);
							if (currentActiveLink) {
								currentActiveLink.classList.remove('active');
								currentActiveLink = null;
							}
						}
					});
				}
				
				// Passive scroll listener for performance
				scrollContainer.addEventListener('scroll', onScroll, { passive: true });
				
				// Initial update
				onScroll();
				
				// Keyboard navigation
				document.addEventListener('keydown', function(e) {
					if (e.altKey || e.ctrlKey || e.shiftKey || e.metaKey) return;
					
					var currentIndex = -1;
					for (var i = 0; i < sections.length; i++) {
						if (sections[i].target === currentTarget) {
							currentIndex = i;
							break;
						}
					}
					
					switch(e.which) {
						case 37: // left
							if (currentIndex > 0) {
								window.location.hash = sections[currentIndex - 1].target;
							} else {
								window.location.hash = 'top';
							}
							e.preventDefault();
							break;
						case 39: // right
							if (currentIndex < sections.length - 1) {
								window.location.hash = sections[currentIndex + 1].target;
							}
							e.preventDefault();
							break;
					}
				});
				
				// Enable keyboard nav status
				var statusEl = document.getElementById('keyboardNavStatus');
				if (statusEl) statusEl.textContent = 'enabled';
			})();
		</script>
	</body>
</html>